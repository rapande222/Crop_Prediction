# -*- coding: utf-8 -*-
"""Crop_Prediction.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1iXPX-4vB1DYatoFDrF5eYRA1t5dBZ59T
"""

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns

from google.colab import drive
drive.mount('/content/drive')

df = pd.read_csv('/content/Crop_details.csv')
df.head()

df.shape

df.info()

df.describe()

crop_counts = df['crop'].value_counts()
crop_counts

plt.figure(figsize=(10, 6))
sns.countplot(data=df, x='crop', palette='viridis')
plt.title('Distribution of Crop Images', fontsize=16, fontweight='bold')
plt.xlabel('Crop Type', fontsize=12)
plt.ylabel('Number of Images', fontsize=12)
plt.xticks(rotation=45)
plt.tight_layout()
plt.show()

df = df.drop('Unnamed: 0', axis=1)

sorted(df['croplabel'].unique())

crop_label = df[['crop','croplabel']].drop_duplicates().sort_values('croplabel')
crop_label_map = dict(zip(crop_label['crop'], crop_label['croplabel']))
crop_label_map

class_distribution = df.groupby(['crop', 'croplabel']).size().reset_index(name='count')
print(class_distribution.to_string(index=False))

import os
from google.colab import files
import zipfile


zip_filename = '/content/Archive.zip'

with zipfile.ZipFile(zip_filename, 'r') as zip_ref:
    zip_ref.extractall('/content/')

df['path'] = df['path'].apply(lambda x: x.split('kag2/')[-1])

base_path = '/content/kag2/'
df['full_path'] = base_path + df['path']

df = df[df['full_path'].apply(os.path.exists)].reset_index(drop=True)

print(f"Total images to use: {len(df)}")
print(f"Images per class:\n{df['crop'].value_counts()}")

import tensorflow as tf
from tensorflow.keras.preprocessing.image import load_img, img_to_array

img_height = 299
img_width = 299

def load_and_preprocess_image(image_path):
    img = load_img(image_path, target_size=(img_height, img_width))
    img_array = img_to_array(img)
    img_array = tf.keras.applications.inception_v3.preprocess_input(img_array)
    return img_array

import os
sample_path = df['full_path'].iloc[0]
print(sample_path)
print(os.path.dirname(sample_path))
print(os.listdir('/content'))

X_train = np.array([load_and_preprocess_image(path) for path in df['full_path']])
y_train = df['croplabel'].values

from tensorflow.keras.applications import InceptionV3
from tensorflow.keras.models import Model
from tensorflow.keras.layers import Dense, GlobalAveragePooling2D
from tensorflow.keras.optimizers import Adam

classes = len(np.unique(y_train))

inception = InceptionV3(include_top=False, input_shape=(299,299,3), pooling='avg', weights='imagenet')
inception.trainable = False

output = Dense(classes, activation='softmax')(inception.output)

model = Model(inputs=inception.input, outputs=output)
model.compile(optimizer='adam', loss='sparse_categorical_crossentropy', metrics=['accuracy'])

model.fit(X_train, y_train, epochs=10, batch_size=32)

model.summary()

from google.colab import drive
drive.mount('/content/drive')
from google.colab import files

model.save('/content/drive/MyDrive/model_dsml42_Inceptionv3.h5')
model.save('model_dsml42_Inceptionv3.h5')

files.download('model_dsml42_Inceptionv3.h5')

import os
print(os.listdir('/content'))

def predict_folder(folder_path):
    results = []
    for filename in os.listdir(folder_path):
        if filename.endswith(('.jpg', '.jpeg', '.png')):
            img_path = os.path.join(folder_path, filename)
            img = load_img(img_path, target_size=(299, 299))
            img_array = img_to_array(img)
            img_array = tf.keras.applications.inception_v3.preprocess_input(img_array)

            pred = model.predict(np.expand_dims(img_array, axis=0))
            pred_class = np.argmax(pred[0])
            results.append((filename, pred_class))
    return results


if os.path.exists(folder_path):
    predictions = predict_folder(folder_path)
    #for filename, pred_class in predictions:
     #   print(f"{filename}: Class {pred_class}")
else:
    print("Folder not found!")

crop_label_map

for filename, pred_class in predictions:
    # Extract crop word from filename
    crop_word = None
    for crop in crop_label_map.keys():
        if crop in filename.lower():
            crop_word = crop
            break

    predicted = label_to_name[pred_class]
    print(f"img- {crop_word}: pred- {predicted}, class- {pred_class}")

"""The model achieved 46.67% accuracy on test images, showing it can recognize crops but needs improvement. It performs best on maize and wheat, while struggling with sugarcane and juteâ€”likely due to insufficient or imbalanced training data for those classes."""

